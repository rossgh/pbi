<!DOCTYPE html>
<html>
<head>
  <title>Voice Chat Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { font-size: 16px; margin: 5px; }
    #userText, #botResponse { font-weight: bold; }
    #log { margin-top: 20px; background: #f9f9f9; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ðŸŽ¤ Voice Chat with Azure GPT-4o + Azure Neural TTS</h2>
  <button id="start">Start Speaking</button>
  <button id="cancelSpeech">ðŸš« Stop Talking</button>
  <p><strong>You said:</strong> <span id="userText">...</span></p>
  <p><strong>Response:</strong> <span id="botResponse">...</span></p>
  <div id="log"><strong>Debug Log:</strong>\n</div>

  <script>
    const startBtn = document.getElementById("start");
    const cancelBtn = document.getElementById("cancelSpeech");
    const userTextSpan = document.getElementById("userText");
    const botResponseSpan = document.getElementById("botResponse");
    const logDiv = document.getElementById("log");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.continuous = false;

    function log(msg) {
      logDiv.textContent += `\n${msg}`;
    }

    async function speakAndResume(text) {
      log("Speaking reply with TTS...");
      const ttsResponse = await fetch("/speak", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const blob = await ttsResponse.blob();
      const audioUrl = URL.createObjectURL(blob);
      const audio = new Audio(audioUrl);
      audio.onended = () => {
        log("TTS ended, restarting recognition...");
        recognition.start();
      };
      audio.play();
    }

    recognition.onresult = async (event) => {
      const text = event.results[0][0].transcript;
      userTextSpan.textContent = text;
      log("Recognized speech: " + text);
      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await response.json();
        const reply = data.response || "No response.";
        botResponseSpan.textContent = reply;
        await speakAndResume(reply);
      } catch (err) {
        log("âŒ Error: " + err.message);
      }
    };

    recognition.onerror = (e) => log("Speech recognition error: " + e.error);

    startBtn.onclick = () => {
      recognition.start();
      log("ðŸŽ™ï¸ Speech recognition started...");
    };

    cancelBtn.onclick = () => {
      window.speechSynthesis.cancel();
      recognition.stop();
      log("ðŸ›‘ Speech canceled.");
    };
  </script>
</body>
</html>
