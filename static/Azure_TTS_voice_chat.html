<!DOCTYPE html>
<html>
<head>
  <title>Voice Chat with Azure GPT-4o + Azure TTS</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button, select { font-size: 16px; margin: 5px; }
    #userText, #botResponse { font-weight: bold; }
    #log { margin-top: 20px; background: #f9f9f9; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ğŸ¤ Voice Chat with Azure GPT-4o + Azure Neural TTS</h2>
  <button id="start">Start Speaking</button>
  <button id="cancelSpeech">ğŸ›‘ Stop Talking</button>
  ğŸ”Š Voice: 
  <select id="voiceSelect">
    <option value="en-US-AndrewMultilingualNeural">Andrew</option>
    <option value="en-US-JennyNeural">Jenny</option>
    <option value="en-GB-RyanNeural">Ryan (UK)</option>
  </select>
  <p><strong>You said:</strong> <span id="userText">...</span></p>
  <p><strong>Response:</strong> <span id="botResponse">...</span></p>
  <div id="log"><strong>Debug Log:</strong>\n</div>

  <script>
    const startBtn = document.getElementById("start");
    const cancelBtn = document.getElementById("cancelSpeech");
    const voiceSelect = document.getElementById("voiceSelect");
    const userTextSpan = document.getElementById("userText");
    const botResponseSpan = document.getElementById("botResponse");
    const logDiv = document.getElementById("log");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.continuous = true;

    function log(msg) {
      logDiv.textContent += `\n${msg}`;
    }

    startBtn.onclick = () => {
      recognition.start();
      log("ğŸ™ï¸ Speech recognition started...");
    };

    cancelBtn.onclick = () => {
      window.speechSynthesis.cancel();
      recognition.stop();
      log("ğŸ›‘ Speech recognition and synthesis stopped.");
    };

    recognition.onresult = async (event) => {
      const text = event.results[event.results.length - 1][0].transcript;
      userTextSpan.textContent = text;
      log("Recognized speech: " + text);

      try {
        const chatRes = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });

        const data = await chatRes.json();
        log("âœ… Received response: " + JSON.stringify(data));

        const reply = data.response || "No response from server.";
        botResponseSpan.textContent = reply;

        const voice = voiceSelect.value;
        const ttsRes = await fetch("/speak", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: reply, voice: voice })
        });

        const ttsBlob = await ttsRes.blob();
        const audioUrl = URL.createObjectURL(ttsBlob);
        const audio = new Audio(audioUrl);
        audio.play();

      } catch (error) {
        log("âŒ Error: " + error.message);
        botResponseSpan.textContent = "Error occurred.";
      }
    };

    recognition.onerror = (e) => log("âš ï¸ Speech recognition error: " + e.error);
  </script>
</body>
</html>